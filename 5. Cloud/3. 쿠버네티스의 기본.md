# 쿠버네티스의 기본

## 아키텍처
![Architecture](./image/components-of-kubernetes.svg)

|구성요소|개요|
|--|--|
|kubectl|k8s 클러스터를 조작하기 위한 도구로 커맨드 라인 인터페이스로 제공|
|kube-apiserver|kubectl 등의 API 클라이언트로부터 오는 REST 요청을 검증하고, API 오브젝트를 구성하고 상태를 보고|
|kube-scheduler|생성된 모든 파드에 대해 실행할 최적의 노드를 선택하는 k8s의 기본 스케쥴러|
|kube-controller-manager|컨트롤러를 구동하는 마스터상의 컴포넌트|
|cloud-controller-manager|API를 통해서 클라우드 서비스와 연계하는 컨트롤러|
|etcd|k8s 클러스터의 모든 관리 데이터를 Key/Value 형태로 etcd에 저장하는 저장소|
|kubelet|각 노드에서 실행되며 파드와 컨테이너의 실행, API 서버에 상태 보고, 컨테이너의 동작을 확인하는 프로브 실행을 하는 역할|
|kube-proxy|각 노드에서 실행되며 로드밸런싱 기능을 제공|
|coredns|파드가 서비스 이름으로부터 IP 이름으로부터 IP 주소를 얻기 위해 사용|

___

## 쿠버네티스 API 오프젝트
쿠버네티스에 대한 조작은 모두 API를 통해 이뤄진다. kubectl은 마스터 노드상의 kube-apiserver에게 쿠버네티스 API 규약에 맞게 기술된 목표 상태 선언서인 매니페스트를 YAML 형식 혹은 JSON 형식으로 전송하여 오브젝트를 수정하는 일을 한다.

### __오브젝트(Object)__
오브젝트란 k8s 클러스터 내부의 엔티티로서 Pod, Controller, Service 등이 인스턴스를 의미한다. 각각의 오브젝트는 쿠버네티스 API의 리소스 종류에 맞게 설정되고 생성된다.

각 오브젝트는 메타데이터에 기술된 이름에 의해 식별된다. 따라서 오브젝트를 만들 떄는 반드시 __이름__ 을 부여해야 한다. 같은 종류의 오브젝트의 이름은 하나의 __Namespace__ 에서 반드시 유일해야 한다. Namespace는 k8s 클러스터를 논리적으로 분할하여 사용하기 위해 존재하는 기능이다.

### __워크로드(Workload)__
워크로드란 오브젝트의 __카테고리__ 를 나타내는 용어로 __Container와 Pod, 그리고 Controller의 그룹__ 을 의미한다.

### __파드(Pod)__
파드는 컨테이너를 실행하기 위한 오브젝트이다. 파드는 한 개 혹은 여러 개의 컨테이너를 담을 수 있다.

### __컨테이너(Container)__
쿠버네티스에서 컨테이너만을 독자적으로 실행하는 것을 불가능하고, 반드시 파드 내에서 실행해야 한다.

### __컨트롤러(Controller)__
컨트롤러는 파드의 실행을 제어하는 오브젝트이다. 컨트롤러는 종류가 여러개 있기 때문에 각 역할에 맞춰서 사용해야 한다.

### __설정(Configuraion)__
컨테이너 내 애플리케이션의 설정값을 저장할 수 있는 ConfigMap으로, 네임스페이스에 저장된 정보는 컨테이너 내의 파일이나 환경 변수를 통해 애플리케이션에서 참조할 수 있다.

### __서비스(Service)__
서비스는 파드와 클라이언트를 연결하는 역할을 수행한다. 서버 역할을 수행하는 파드가 클라이언트의 요청을 받을 수 있도록 대표 IP 주소를 취득하여 내부 DNS에 등록한다. 그리고 대표 IP 주소로의 요청 트래픽을 지정된 파드들에 부하분산하며 전송하는 역할도 수행한다.

### __스토리지(Storage)__
파드나 컨테이너는 실행 시에만 존재하는 일시적인 존재이기 떄문에 중요한 데이터를 컨테이너의 파일 시스템에 저장해서는 안 된다. 데이터를 잃지 않기 위해서는 퍼시스턴트 볼륨을 사용하여 전원이 꺼져도 데이터가 유지되는 스토리지 시스템에 데이터를 저장해야 한다.

다만 퍼시스턴트 볼륨은 쿠버네티스의 범위에 포함되지 않기 때문에 외부 스토리지 시스템을 연동해야 하는데, 이때 다양한 외부 스토리지 시스템의 프로토콜과 API의 차이점을 은폐하기 위해 쿠버네티스는 스토리지를 계층적으로 추상화한 오브젝트를 제공한다.

___

## 파드의 기본
파드느느 쿠버네티스에서 컨테이너를 실행하는 최소 단위로 한 개 혹은 여러 개의 컨테이너를 포함한다. 하나의 파드에 속하는 모든 컨테이너들은 같은 노드에서 동작한다. 

### 파드의 특징
- 파드 내부의 컨테이너들은 파드의 IP 주소와 포트번호를 공유한다.
- 파드의 내부 컨테이너들은 localhost로 서로 통신할 수 있다.
- 파드의 내부 컨테이너들은 System V 프로세스 통신이나 POSIX 공유 메모리를 사용하여 서로 통신할 수 있다.
- 파드의 내부 컨테이너들은 파드의 볼륨을 마운트하여 파일 시스템을 공유할 수 있다.

### __일시적인 존재__
파드는 __일시적 존재로 설계되어__ 파드 내의 컨테이너는 이미지로부터 매번 생성된다. 즉, 같은 오브젝트 이름으로 몇 번이고 파드를 기동해도 이전에 컨테이너에서 수행한 변경 이력은 남지 않고, 이미지의 초기 상태에서 시작한다.

또한, 파드의 IP 주소도 고정적이지 않다. 파드의 IP 주소는 기동 시 부여되고, 종료 시에 회수되어 다른 파드가 기동할 때 사용된다. 따라서 파드에 요청을 보내고 싶은 경우에는 반드시 __서비스__ 를 사용해야 한다.

### __실행 상태 관리__
파드가 정지한 경우에는 담당 __컨트롤러__ 가 재기동 등의 정해진 처리를 수행하는 한편, 파드 내부의 컨테이너가 정지한 경우에는 파드가 해당 컨테이너를 재시작한다.

또한 파드는 Liveness Probe와 Readiness Probe를 설정하여 내부 애플리케이션의 상태를 감시할 수 있다. 예를들어 Liveness Probe를 설정하면 애플리케이션이 멈춰 있는 상태를 감지하여 __컨테이너를 강제 종류__ 시킬 수 있다. 반면, Readiness Probe를 설정하면, 파드가 요청을 받을 준비가 될 때까지 서비스 오브젝트가 요청을 전송하지 않는다.

### __초기화 전용 컨테이너__
파드에 초기화만을 담당하는 컨테이너를 설정할 수 있다. 그러면 파드가 기동된 후 초기화 담당 컨테이너가 제일 먼저 실행되며 초기화가 끝나면 핵심 기능을 수행하는 컨테이너들이 실행된다.

___

## 파드의 Life Cycle
쿠버네티스의 트러블 슈팅 중 가장 많이 발생하는 것이 파드의 기동 실패 원인 분석이다. 개인의 개발 환경에서 컨테이너 이미지를 빌드하고 쿠버네티스 환경에 배포했을 때 제일 먼저 경험하는 것이 컨테이너가 기동하지 않거나 재시작을 반복하는 현상이다. 이러한 이유로 파드의 상태가 가지는 의미를 파악 후 적절하게 대처할 수 있어야 한다.

문제를 파악하기 위해서는 'kubectl get pods'를 실행했을 때 나타나는 STATUS 열의 정보가 중요하다.

|STATUS|의미와 대책|
|--|--|
|ContianerCreating|이미지를 다운로드 중이거나 컨테이너를 생성하는 중에 있다. __ConfigMap과 Secret이 마운트 되지 않아 컨테이너 생성이 보류된 경우일 수도 있다.__
|CrashLoopBackOff|파드 내의 컨테이너가 종료되어 다음 기동 시까지 대기 상태에 있음을 의미한다. 2회 이상 컨테이너가 종료되면, CrashLoopBackOff 시간 동안 대기하게 된다. __컨테이너 내의 프로세스를 검토할 필요가 있다.__|
|Pending|파드 생성 요구를 받았지만 하나 이상의 컨테이너가 생성되지 않은 상태를 의미한다. __리소스 부족 등의 이유로 스케쥴이 되지 않은 경우에 해당한다.__|
|Running|파드의 모든 컨테이너가 생성되어 실행 중임을 의미한다.|
|Termination|컨테이너에 종료 요청 시그널을 보낸 후 컨테이너가 종료할 때까지 대기 중임을 의미한다. 유예 시간을 넘겨도 컨테이너가 종료할 수 없는 경우는, 컨테이너를 강제로 종료한다.|
|Succeeded|파드 내 모든 컨테이너가 정상적으로 종료했음을 의미한다.|
|Completed|파드 내 컨테이너가 정상적으로 종료되었음을 의미한다. 파드 내의 복수개의 컨테이너가 있는 경우, 첫 번째 컨테이너가 정상 종료(Exit Code == 0)하면 표시된다.|
|Error|컨테이너가 이상 종료된 경우다. Exit 코드가 0이 아닌 경우에 이상 종료로 간주한다. 파드 내의 복수개의 컨테이너가 있는 경우, 첫 번째 컨테이너가 이상 종료(Exit Code != 0)하면 표시된다.|
|Failed|파드 내에 적어도 하나의 컨테이너가 이상 종료했음을 의미한다.|
|Unknown|파드의 상태를 얻을 수 없는 상황을 의미한다.|

## 파드의 종료 처리
쿠버네티스는 종료 요청 시그널을 받은 컨테이너의 애플리케이션이 일정 시간 내에 종료 처리를 완료하고 정상 종료를 하도록 요구한다.

예를 들어, 쿠버네티스에는 롤아웃이라는 기능이 있는데, 운영 중인 애플리케이션을 가동 중에 업데이트하는 기능이다. 이 기능을 담당하는 컨트롤러는 가동중인 애플리케이션에 종료 요청 시그널을 보내고 유예 시간까지 파드의 종료를 기다린다.